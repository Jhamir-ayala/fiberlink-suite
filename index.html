<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiberLink ENG Suite | Planta Externa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Pro -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet & Esri Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cad-bg': '#0a0a0a',
                        'cad-panel': '#151515',
                        'cad-border': '#2a2a2a',
                        'cad-accent': '#00bcd4', 
                        'cad-warning': '#ff9800',
                        'cad-danger': '#f44336',
                        'cad-success': '#4caf50',
                        'device-yellow': '#f59e0b',
                        'lcd-bg': '#2b3a2a',
                        'lcd-text': '#4ade80'
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        digital: ['Share Tech Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #e0e0e0; overflow: hidden; }
        
        /* INSTRUMENTOS */
        .opm-device {
            background: #1a1a1a; border: 4px solid #f59e0b; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8), inset 0 0 10px rgba(0,0,0,0.5);
            width: 280px; position: absolute; z-index: 9999; overflow: hidden;
        }
        .opm-screen {
            background: #36423b;
            background-image: linear-gradient(180deg, rgba(0,0,0,0.1) 50%, rgba(255,255,255,0.05) 50%);
            background-size: 100% 4px; border: 2px inset #111; border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            font-family: 'Share Tech Mono', monospace; color: #d1fae5; text-shadow: 0 0 5px #4ade80;
            padding: 10px; margin: 10px; position: relative;
        }
        .flash { animation: screen-flash 0.3s ease-out; }
        @keyframes screen-flash {
            0% { background-color: #36423b; }
            50% { background-color: #86efac; color: #000; text-shadow: none; }
            100% { background-color: #36423b; }
        }

        .opm-button {
            width: 30px; height: 30px; border-radius: 50%;
            background: linear-gradient(145deg, #333, #222);
            box-shadow: 2px 2px 5px #111, -1px -1px 2px #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #888; border: 1px solid #000; cursor: pointer; transition: all 0.1s;
        }
        .opm-button:active { box-shadow: inset 2px 2px 5px #111; transform: scale(0.95); }
        .opm-button:hover { color: #fff; }

        .otdr-frame {
            background: #202020; border-top: 4px solid #333; border-right: 4px solid #333;
            border-radius: 8px 8px 0 0; box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
            display: flex; flex-direction: column; height: 100%;
        }
        
        .otdr-key {
            height: 100%; width: 4rem;
            background: linear-gradient(180deg, #333, #222);
            border: 1px solid #000; border-radius: 4px;
            color: #888; font-size: 9px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.1s;
        }
        .otdr-key:active { background: #111; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transform: translateY(1px); }
        .otdr-key:hover { color: #fff; border-color: #555; }

        .scope-bezel {
            width: 160px; height: 160px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #444, #111);
            border: 4px solid #000; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .scope-overlay {
            position: absolute; inset: 0; border-radius: 50%;
            background: url('data:image/svg+xml;utf8,<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><circle cx="50%" cy="50%" r="40%" stroke="rgba(0,255,0,0.3)" stroke-width="1" fill="none"/><line x1="50%" y1="0" x2="50%" y2="100%" stroke="rgba(0,255,0,0.3)" stroke-width="1"/><line x1="0" y1="50%" x2="100%" y2="50%" stroke="rgba(0,255,0,0.3)" stroke-width="1"/></svg>');
            pointer-events: none; z-index: 10;
        }

        .cad-btn { @apply flex flex-col items-center justify-center w-full py-3 px-1 text-[10px] uppercase tracking-wider font-bold text-gray-500 bg-cad-panel border-l-2 border-transparent hover:bg-[#222] hover:text-white transition-all mb-2; }
        .cad-btn.active { @apply bg-[#1a1a1a] text-cad-accent border-cad-accent shadow-[inset_5px_0_10px_rgba(0,188,212,0.1)]; }
        .cad-input { width: 100%; background-color: #080808 !important; border: 1px solid #333 !important; color: #00bcd4 !important; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 6px 8px; outline: none; border-radius: 2px; }
        .cad-label { @apply text-[9px] text-gray-500 uppercase font-bold mb-1 block tracking-wider; }

        .leaflet-container { background: #050505; }
        
        .icon-pole { background: #666; border: 1px solid #aaa; border-radius: 50%; box-shadow: 2px 2px 5px rgba(0,0,0,0.8); }
        .icon-mufa { background: #333; border: 2px solid #ff9800; border-radius: 4px; }
        .icon-nap { background: #000; border: 2px solid #fff; border-radius: 2px; box-shadow: 0 0 5px black; }
        .icon-camera { background: #9c27b0; border: 1px solid #fff; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 10px; }

        .pulse-icon { border-radius: 50%; border: 2px solid #00bcd4; background: rgba(0, 188, 212, 0.4); box-shadow: 0 0 15px #00bcd4; animation: pulse-animation 1.5s infinite; }
        @keyframes pulse-animation { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

        #ai-panel { box-shadow: -5px 0 30px rgba(0,0,0,0.8); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #ai-panel.open { transform: translateX(0); }
        .ai-message { @apply mb-2 p-2 rounded text-xs leading-snug; }
        .ai-message.user { @apply bg-[#2a2a2a] text-white border border-gray-700 ml-4; }
        .ai-message.bot { @apply bg-indigo-900/20 text-gray-300 border-l-2 border-indigo-500 mr-2 rounded-l-none pl-3; }
        .ai-message.bot strong { @apply text-indigo-300; }
        .ai-typing::after { content: '...'; animation: ellipsis 1.5s infinite; }
        @keyframes ellipsis { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

        .toast { background: #1a1a1a; border-left: 4px solid #00bcd4; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out forwards; font-size: 12px; display: flex; align-items: center; gap: 10px; border: 1px solid #333; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .zoom-indicator { position: absolute; top: 5px; right: 5px; background: rgba(0,188,212,0.2); border: 1px solid #00bcd4; color: #00bcd4; font-size: 9px; padding: 2px 4px; border-radius: 2px; display: none; }
        #opm-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #4ade80; color: #000; padding: 2px 5px; font-weight: bold; display: none; pointer-events: none; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans text-sm bg-black overflow-hidden">

    <!-- HEADER -->
    <header class="h-12 bg-cad-panel border-b border-cad-border flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-cad-accent">
                <i class="fa-solid fa-network-wired text-xl"></i>
                <div class="flex flex-col">
                    <span class="font-bold tracking-widest text-sm leading-none">FIBER<span class="text-white">LINK</span></span>
                    <span class="text-[9px] text-gray-500 font-mono tracking-widest">PLANTA EXTERNA</span>
                </div>
            </div>
            <div class="h-6 w-px bg-cad-border mx-2"></div>
            <div class="flex flex-col">
                <span class="text-[9px] text-gray-500 uppercase">Zona Operativa</span>
                <span class="text-xs font-mono text-gray-300">LIMA METROPOLITANA</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="text-right mr-4 hidden md:block">
                <span class="block text-[9px] text-gray-500 uppercase">Enlace</span>
                <span id="header-status" class="text-xs font-bold text-cad-success bg-green-900/20 px-2 py-0.5 rounded border border-green-900/50">OPERATIVO</span>
            </div>
            <button onclick="app.toggleAI()" class="flex items-center gap-2 bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 border border-indigo-500/50 px-3 py-1.5 rounded transition-all group">
                <i class="fa-solid fa-microchip text-indigo-400 group-hover:text-white transition-colors"></i>
                <span class="text-xs font-bold">Copiloto</span>
            </button>
            <button onclick="app.exportReport()" class="bg-[#222] hover:bg-[#333] text-white px-3 py-1.5 rounded text-xs border border-gray-700 transition flex items-center gap-2">
                <i class="fa-solid fa-file-excel text-green-500"></i>Exportar
            </button>
        </div>
    </header>

    <!-- WORKSPACE -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- TOOLBAR -->
        <aside class="w-20 bg-[#0c0c0c] border-r border-cad-border flex flex-col items-center py-2 z-40 overflow-y-auto shrink-0">
            <div class="text-[8px] text-gray-600 font-bold mb-2 uppercase tracking-widest w-full text-center">Inspección</div>
            <button onclick="app.setTool('cursor')" id="tool-cursor" class="cad-btn active" title="Cursor"><i class="fa-solid fa-arrow-pointer"></i><span>Cursor</span></button>
            
            <div class="h-px w-10 bg-cad-border my-1"></div>
            <div class="text-[8px] text-gray-600 font-bold mb-2 uppercase tracking-widest w-full text-center">Pasivos</div>
            <button onclick="app.setTool('splice')" id="tool-splice" class="cad-btn"><i class="fa-solid fa-xmarks-lines text-orange-500"></i><span>Empalme</span></button>
            <button onclick="app.setTool('connector')" id="tool-connector" class="cad-btn"><i class="fa-solid fa-grip-lines-vertical text-gray-300"></i><span>Conector</span></button>
            <button onclick="app.setTool('splitter')" id="tool-splitter" class="cad-btn"><i class="fa-solid fa-share-nodes text-purple-400"></i><span>Splitter</span></button>
            
            <div class="h-px w-10 bg-cad-border my-1"></div>
            <div class="text-[8px] text-gray-600 font-bold mb-2 uppercase tracking-widest w-full text-center">Activos</div>
            <button onclick="app.setTool('amp')" id="tool-amp" class="cad-btn"><i class="fa-solid fa-caret-right text-green-500"></i><span>EDFA</span></button>
            
            <div class="mt-auto w-full px-2 pb-2">
                <button onclick="app.toggleView()" class="w-full bg-blue-900/30 text-blue-400 border border-blue-800 rounded py-2 hover:bg-blue-900/50 transition"><i class="fa-solid fa-map-location-dot"></i></button>
            </div>
        </aside>

        <!-- MAIN VIEW -->
        <div class="flex-1 flex flex-col relative bg-[#050505] overflow-hidden">
            
            <!-- OPM HUD -->
            <div id="hud-meter" class="opm-device hidden transition-all duration-200 top-6 right-6">
                <div class="flex justify-between items-center px-3 py-2 bg-[#222] border-b border-[#333]">
                    <span class="text-[10px] font-bold text-gray-400 tracking-widest">OPM-300 PRO</span>
                    <i class="fa-solid fa-battery-full text-green-500 text-xs"></i>
                </div>
                <div class="opm-screen" id="opm-lcd">
                    <div class="flex justify-between items-end border-b border-white/10 pb-1 mb-2">
                        <span id="hud-lambda" class="text-sm text-yellow-300">AUTO</span>
                        <span id="hud-mode" class="text-[9px] uppercase tracking-widest">ABS</span>
                    </div>
                    <div id="hud-service" class="text-xs text-center text-cyan-400 font-bold tracking-wider mb-1">--</div>
                    <div class="text-center py-2 relative">
                        <div id="hud-pwr" class="text-4xl font-bold tracking-widest">-00.00</div>
                        <div id="hud-unit" class="text-sm text-gray-400">dBm</div>
                        <div id="opm-msg" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#4ade80;color:#000;padding:2px 5px;">SAVED</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-white/10 text-[10px]">
                        <div>REF: <span id="hud-ref-val" class="text-white">--</span></div>
                        <div>OFF: <span class="text-white">0.0</span></div>
                    </div>
                </div>
                <div class="px-4 pb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] text-gray-500 uppercase font-bold">Ubicación</span>
                        <span id="hud-dist" class="text-xs font-mono text-white bg-black px-2 py-0.5 rounded border border-gray-700">-- km</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[9px] text-gray-500 uppercase font-bold">Hilo</span>
                        <span id="hud-fiber-id" class="text-xs text-white">--</span>
                    </div>
                </div>
                <div class="bg-[#111] p-3 flex justify-around border-t border-[#333]">
                    <div class="opm-button" onclick="app.opmSave()" title="Guardar"><i class="fa-solid fa-floppy-disk"></i></div>
                    <div class="opm-button" onclick="app.opmCycleLambda()" title="Lambda"><i class="fa-solid fa-wave-square"></i></div>
                    <div class="opm-button" onclick="app.opmSetRef()" title="Ref"><i class="fa-solid fa-ruler-horizontal"></i></div>
                    <div class="opm-button text-red-500 border-red-900" title="Cerrar" onclick="app.closeHUD()"><i class="fa-solid fa-power-off"></i></div>
                </div>
            </div>

            <!-- MAP LAYER -->
            <div id="map-layer" class="absolute inset-0 z-10 hidden"></div>

            <!-- SCHEMATIC LAYER -->
            <div id="schematic-layer" class="absolute inset-0 z-20 flex flex-col">
                <div id="schematic-container" class="flex-1 relative border-b border-cad-border bg-[#080808] cursor-crosshair">
                    <canvas id="fiberCanvas" class="relative z-10"></canvas>
                </div>
                
                <!-- INSTRUMENTS BOTTOM -->
                <div class="h-64 bg-[#111] border-t border-cad-border flex shrink-0 p-1 gap-1">
                    <!-- OTDR -->
                    <div class="flex-1 bg-[#202020] border-t-4 border-r-4 border-[#333] rounded-t-lg flex flex-col">
                        <div class="h-6 bg-[#2a2a2a] px-3 flex items-center justify-between border-b border-black">
                            <span class="text-[9px] font-bold text-gray-300 tracking-widest">OTDR TRACE</span>
                            <span class="text-[8px] text-gray-500">REAL-TIME</span>
                        </div>
                        <div class="flex-1 p-2 bg-black relative">
                            <div class="h-full w-full border border-gray-800 rounded bg-[#050505]">
                                <canvas id="otdrChart"></canvas>
                            </div>
                            <div id="otdr-zoom-badge" class="zoom-indicator">ZOOM ACTIVE</div>
                        </div>
                        <div class="h-8 bg-[#181818] flex justify-center gap-1 p-1">
                            <div class="otdr-key" onclick="app.otdrAuto()">AUTO</div>
                            <div class="otdr-key" onclick="app.otdrRange()">RANGE</div>
                            <div class="otdr-key" onclick="app.otdrZoom()">ZOOM</div>
                            <div class="otdr-key" onclick="app.otdrEvents()">EVENTS</div>
                        </div>
                    </div>
                    <!-- Scope -->
                    <div class="w-56 bg-[#1a1a1a] border border-[#333] rounded flex flex-col items-center justify-center relative">
                        <span class="absolute top-2 left-2 text-[8px] text-gray-500 font-bold bg-black px-1 rounded">SCOPE</span>
                        <div class="scope-bezel">
                            <div class="scope-overlay"></div>
                            <canvas id="cross-section-canvas" style="width:120px;height:120px;border-radius:50%;"></canvas>
                        </div>
                        <div class="mt-2 text-[9px] text-green-400 font-mono bg-black/50 rounded py-0.5 px-2">PASS: IEC-61300</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <aside class="w-72 bg-cad-panel border-l border-cad-border flex flex-col z-30 shadow-2xl shrink-0">
            <div class="p-4 border-b border-cad-border bg-[#181818]">
                <span class="text-[9px] text-cad-accent uppercase font-bold">Herramienta</span>
                <div class="flex items-center gap-2 text-white mt-1">
                    <i id="tool-icon-display" class="fa-solid fa-arrow-pointer"></i>
                    <span id="tool-name-display" class="font-bold text-sm">CURSOR</span>
                </div>
                <p id="tool-desc-display" class="text-[10px] text-gray-500 mt-1 leading-tight">Haz clic en un hilo o en el mapa para inspeccionar.</p>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <div class="space-y-3">
                    <div class="flex justify-between"><span class="cad-label">Parámetros</span></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="text-[9px] text-gray-500">Longitud (km)</span><input type="number" id="param-dist" value="80.0" class="cad-input text-right"></div>
                        <div><span class="text-[9px] text-gray-500">Tx (dBm)</span><input type="number" id="param-tx" value="3.0" class="cad-input text-right"></div>
                    </div>
                    <div><span class="text-[9px] text-gray-500">Degradación (dB/km)</span><input type="number" id="param-deg" value="0.00" step="0.01" class="cad-input text-right"></div>
                </div>
                <div class="h-px bg-[#222]"></div>
                <!-- Fiber Info -->
                <div class="bg-[#111] p-3 rounded border border-cad-border">
                    <span class="cad-label text-cad-accent mb-2">Hilo Activo</span>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">ID</span><span id="panel-fiber-id" class="text-white">--</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Servicio</span><span id="panel-service" class="text-white font-bold">--</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Atenuación</span><span id="panel-coef" class="text-gray-300">--</span></div>
                    </div>
                </div>
                <div class="h-px bg-[#222]"></div>
                <!-- Events -->
                <div>
                    <div class="flex justify-between items-center mb-2"><span class="cad-label">Eventos</span><span id="event-count" class="text-[9px] bg-[#222] text-white px-2 rounded">0</span></div>
                    <div id="events-list" class="space-y-1 max-h-40 overflow-y-auto">
                        <div class="text-center py-2 text-gray-600 italic text-[10px]">Vacío</div>
                    </div>
                </div>
                <!-- Editor -->
                <div id="prop-panel" class="hidden bg-[#1a1a1a] p-3 rounded border border-cad-accent/30 shadow-lg">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-white">Editar</span><span id="edit-type" class="text-[9px] bg-black px-1 rounded text-gray-400">TYPE</span></div>
                    <div class="space-y-2">
                        <input id="prop-km" type="number" step="0.01" class="cad-input" placeholder="KM">
                        <input id="prop-val" type="number" step="0.1" class="cad-input" placeholder="dB">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="app.updateSelected()" class="bg-cad-accent text-black text-[10px] font-bold py-1 rounded">GUARDAR</button>
                            <button onclick="app.deleteSelected()" class="bg-red-900/30 text-red-400 border border-red-900/50 text-[10px] font-bold py-1 rounded">BORRAR</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-2 border-t border-cad-border text-center bg-[#0a0a0a]">
                <button onclick="app.resetEvents()" class="text-[9px] text-red-600 hover:text-red-400 uppercase font-bold">RESETEAR TODO</button>
            </div>
        </aside>

        <!-- TOASTS -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-[10000] flex flex-col gap-2"></div>

        <!-- AI COPILOT -->
        <div id="ai-panel" class="absolute top-0 right-0 w-80 h-full bg-[#151515] border-l border-cad-border z-50 flex flex-col">
            <div class="h-12 bg-indigo-900/30 border-b border-indigo-500/30 flex items-center justify-between px-4">
                <div class="flex items-center gap-2 text-indigo-400"><i class="fa-solid fa-robot"></i><span class="font-bold text-sm">Copiloto</span></div>
                <button onclick="app.toggleAI()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="ai-chat-content" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="ai-message bot">Hola. Analizo tu red en tiempo real.</div>
            </div>
            <div class="p-3 bg-[#0a0a0a] border-t border-cad-border">
                <div class="flex gap-2">
                    <input type="text" id="ai-input" class="flex-1 bg-[#1a1a1a] border border-gray-700 rounded px-2 py-1 text-xs text-white" placeholder="Pregunta algo..." onkeypress="if(event.key === 'Enter') app.askGemini()">
                    <button onclick="app.askGemini()" class="bg-indigo-600 text-white w-8 h-8 rounded flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const SERVICES = {
            INTERNET: { name: 'INTERNET (GPON)', lambda: 1490, color: '#00bcd4', attenuation: 0.25 },
            TV:       { name: 'TV CABLE (RF)',   lambda: 1550, color: '#e91e63', attenuation: 0.22 },
            PHONE:    { name: 'TELEFONÍA (VoIP)',lambda: 1310, color: '#ffeb3b', attenuation: 0.35 },
            CCTV:     { name: 'CCTV SEGURIDAD',  lambda: 1577, color: '#9c27b0', attenuation: 0.22 },
            DARK:     { name: 'FIBRA OSCURA',    lambda: 0,    color: '#333333', attenuation: 0 }
        };
        const CABLE_CONFIG = [
            { id: 1, colorName: 'Azul',    hex: '#0074D9', svc: 'INTERNET', txOffset: 0 },
            { id: 2, colorName: 'Naranja', hex: '#FF851B', svc: 'INTERNET', txOffset: 0 },
            { id: 3, colorName: 'Verde',   hex: '#2ECC40', svc: 'TV',       txOffset: 1 },
            { id: 4, colorName: 'Marrón',  hex: '#85144b', svc: 'TV',       txOffset: 1 },
            { id: 5, colorName: 'Gris',    hex: '#AAAAAA', svc: 'PHONE',    txOffset: -1 },
            { id: 6, colorName: 'Blanco',  hex: '#FFFFFF', svc: 'PHONE',    txOffset: -1 },
            { id: 7, colorName: 'Rojo',    hex: '#FF4136', svc: 'CCTV',     txOffset: 0 },
            { id: 8, colorName: 'Negro',   hex: '#333333', svc: 'CCTV',     txOffset: 0 },
            { id: 9, colorName: 'Amarillo',hex: '#FFDC00', svc: 'DARK',     txOffset: 0 },
            { id: 10,colorName: 'Violeta', hex: '#B10DC9', svc: 'DARK',     txOffset: 0 },
            { id: 11,colorName: 'Rosa',    hex: '#F012BE', svc: 'DARK',     txOffset: 0 },
            { id: 12,colorName: 'Aqua',    hex: '#7FDBFF', svc: 'DARK',     txOffset: 0 }
        ];
        
        // RUTA REALISTA DE ALTA DENSIDAD (San Isidro -> Via Expresa -> Barranco -> Chorrillos -> Panamericana)
        // Coordenadas trazadas siguiendo las curvas reales de las avenidas principales.
        const ROUTE_NODES = [
            [-12.0967, -77.0250], // Rivera Navarrete
            [-12.0975, -77.0245], [-12.0990, -77.0242], [-12.1020, -77.0238], // Acceso Via Expresa
            [-12.1050, -77.0235], // Aramburu
            [-12.1080, -77.0230], [-12.1120, -77.0225], // Angamos
            [-12.1180, -77.0215], [-12.1250, -77.0205], // Benavides
            [-12.1320, -77.0195], [-12.1380, -77.0190], // 28 de Julio
            [-12.1420, -77.0195], // Fin Vía Expresa
            [-12.1440, -77.0210], [-12.1460, -77.0220], [-12.1480, -77.0225], // Bajada Armendariz (Curva)
            [-12.1500, -77.0215], // Ingreso a Grau
            [-12.1530, -77.0190], [-12.1560, -77.0175], // Av Grau Barranco
            [-12.1600, -77.0150], [-12.1650, -77.0130], // Av San Martin / Huaylas
            [-12.1700, -77.0110], [-12.1750, -77.0090], [-12.1800, -77.0070], // Chorrillos Centro
            [-12.1850, -77.0050], [-12.1900, -77.0020], // Curva Chorrillos inicio
            [-12.1940, -76.9980], [-12.1960, -76.9940], [-12.1980, -76.9900], // La Curva
            [-12.2020, -76.9850], [-12.2060, -76.9820], // Pantanos de Villa inicio
            [-12.2150, -76.9780], [-12.2250, -76.9700], // Panamericana Sur recta
            [-12.2350, -76.9600], [-12.2450, -76.9400], // Peaje
            [-12.2600, -76.9000], [-12.2720, -76.8700]  // Lurin
        ];

        const TOOL_INFO = {
            cursor: { name: 'CURSOR', icon: 'fa-arrow-pointer', desc: 'Inspección' },
            splice: { name: 'EMPALME', icon: 'fa-xmarks-lines', desc: 'Fusión (0.1dB)' },
            connector: { name: 'CONECTOR', icon: 'fa-grip-lines-vertical', desc: 'UPC/APC (0.5dB)' },
            splitter: { name: 'SPLITTER', icon: 'fa-share-nodes', desc: '1:8 (10.5dB)' },
            amp: { name: 'EDFA', icon: 'fa-caret-right', desc: 'Ganancia (20dB)' }
        };
        const apiKey = "";
        const OPM_LAMBDAS = [1310, 1490, 1550, 1577, 1625, 'AUTO'];

        class FiberEngine {
            constructor() {
                this.state = {
                    dist: 80.0, baseTx: 3.0, globalDegradation: 0.0,
                    events: [], selectedEventId: null, activeFiberIndex: 0, tool: 'cursor', view: 'schematic',
                    lockedPoint: null, mapInspectMarker: null, mapEventMarkers: [],
                    opm: { lambdaIdx: 5, ref: null }, otdr: { rangeIdx: 2, zoom: false, showEvents: true }
                };
                this.otdrRanges = [10, 40, 80, 160];
                this.canvas = document.getElementById('fiberCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.container = document.getElementById('schematic-container');
                
                this.initMap(); this.initOTDR(); this.initCrossSection(); this.bindInputs(); this.loop();
                this.updateToolPanel(); this.updateOTDR(); this.drawSchematic();
            }

            // --- MOVED UP: CRITICAL UI METHODS ---
            toggleView() {
                const ml = document.getElementById('map-layer'); const sl = document.getElementById('schematic-layer');
                if (this.state.view === 'schematic') {
                    this.state.view = 'map'; ml.classList.remove('hidden'); sl.classList.add('hidden'); setTimeout(() => this.map.invalidateSize(), 100);
                } else {
                    this.state.view = 'schematic'; ml.classList.add('hidden'); sl.classList.remove('hidden');
                }
            }

            updateToolPanel() {
                const info = TOOL_INFO[this.state.tool];
                this.setText('tool-name-display', info.name);
                const iconEl = document.getElementById('tool-icon-display');
                if(iconEl) iconEl.className = `fa-solid ${info.icon}`;
                this.setText('tool-desc-display', info.desc);
            }

            setTool(t) {
                this.state.tool = t;
                document.querySelectorAll('.cad-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tool-'+t).classList.add('active');
                this.updateToolPanel();
            }

            // --- CORE LOGIC ---
            calcPowerAt(km, fiberIdx) {
                const fiberDef = CABLE_CONFIG[fiberIdx];
                const service = SERVICES[fiberDef.svc];
                if (service.name === 'FIBRA OSCURA') return -60;
                
                let p = this.state.baseTx + fiberDef.txOffset;
                let attenuation = service.attenuation + this.state.globalDegradation;
                
                const effectiveKm = Math.min(km, this.state.dist);
                p -= (effectiveKm * attenuation);
                
                for(let ev of this.state.events) {
                    if (ev.km <= km && ev.fiberIdx === fiberIdx) {
                        if (ev.type === 'amp') p += ev.val; else p -= ev.val;
                    }
                }
                return p;
            }

            // --- GIS MAP ENGINE ---
            initMap() {
                this.map = L.map('map-layer', { center: ROUTE_NODES[4], zoom: 13, zoomControl:false }); // Zoomed in to see detail
                if(L.esri) {
                    L.esri.basemapLayer('Imagery').addTo(this.map);
                    L.esri.basemapLayer('ImageryLabels').addTo(this.map);
                } else {
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                }

                this.drawMapFiberLines();
                this.infraLayer = L.layerGroup().addTo(this.map);
                this.addInfrastructureMarkers();
            }

            drawMapFiberLines() {
                // VERY TIGHT OFFSET to simulate a cable bundle on the street poles (approx 2m width visual)
                // We need to calculate perpendicular offsets for each segment, but for simulation speed we use a simplified lat/lng shift
                // Improved logic: Calculate offset based on segment direction would be better, but simple shift works for demo at high zoom
                
                CABLE_CONFIG.forEach((fib, i) => {
                    // Create points array with slight offset per fiber
                    // Note: A true GIS offset needs complex geometry lib (JSTS/Turf). 
                    // We simulate it by shifting lat/lng slightly based on fiber index to separate lines visually
                    const latShift = (i - 5.5) * 0.00002; // Very small shift (~2m)
                    const lngShift = (i - 5.5) * 0.00002;

                    const offsetPoints = ROUTE_NODES.map(pt => [pt[0] + latShift, pt[1] + lngShift]);
                    
                    const line = L.polyline(offsetPoints, { color: fib.hex, weight: 2, opacity: 0.8 }).addTo(this.map);
                    
                    line.on('click', (e) => {
                        // Find closest segment index for accurate KM
                        let minDist = Infinity; let segIndex = 0;
                        for(let j=0; j<offsetPoints.length-1; j++) {
                            const p1 = L.latLng(offsetPoints[j]);
                            const p2 = L.latLng(offsetPoints[j+1]);
                            const distToSeg = L.LineUtil.pointToSegmentDistance(this.map.project(e.latlng), this.map.project(p1), this.map.project(p2));
                            if(distToSeg < minDist) { minDist = distToSeg; segIndex = j; }
                        }
                        
                        const totalSegments = offsetPoints.length - 1;
                        // Approx ratio along total path
                        const ratio = (segIndex + 0.5) / totalSegments; 
                        let km = ratio * this.state.dist;
                        
                        if (this.state.tool === 'cursor') {
                            this.inspectFiber(km, i);
                            this.updateMapInspectionMarker(e.latlng);
                        } else {
                            this.addEvent(km, this.state.tool, i);
                        }
                    });
                    line.bindTooltip(`HILO ${fib.id}`, { sticky:true });
                });
            }

            addInfrastructureMarkers() {
                // PLACES REAL INFRASTRUCTURE ON NODES
                // Poles at every node
                ROUTE_NODES.forEach((pt, i) => {
                    L.circleMarker(pt, { radius: 2, color: '#999', fillColor: '#ccc', fillOpacity: 1 }).addTo(this.infraLayer);
                });

                // --- DROP CABLE SIMULATION (Bajadas perpendiculares) ---
                
                // 1. Internet Drop (Barranco - Av Grau)
                const nodeBarranco = ROUTE_NODES[14]; // Near Grau
                const mufaIcon = L.divIcon({className: 'icon-mufa', iconSize:[10,10]});
                L.marker(nodeBarranco, {icon: mufaIcon}).addTo(this.infraLayer).bindPopup("MUFA NAP");
                
                // Drop perpendicular to the street
                const housePt = [nodeBarranco[0] + 0.0003, nodeBarranco[1] + 0.0003]; 
                L.polyline([nodeBarranco, housePt], {color:'white', weight:1, dashArray:'3,3'}).addTo(this.map);
                const napIcon = L.divIcon({className:'icon-nap', iconSize:[8,8]});
                L.marker(housePt, {icon:napIcon}).addTo(this.map).bindPopup("NAP-045");

                // 2. CCTV Drop (Chorrillos - Curva)
                const nodeCurva = ROUTE_NODES[24]; // Approx index 24 in high density (mapped to idx 10 in simplified list above, adjusted)
                // Using array index safely:
                const safeIdx = Math.min(ROUTE_NODES.length-2, 20);
                const camNode = ROUTE_NODES[safeIdx];
                
                L.marker(camNode, {icon: mufaIcon}).addTo(this.infraLayer);
                const camPt = [camNode[0] - 0.0003, camNode[1] + 0.0002];
                L.polyline([camNode, camPt], {color:'red', weight:1, dashArray:'3,3'}).addTo(this.map);
                const camIcon = L.divIcon({className:'icon-camera', html:'<i class="fa-solid fa-video" style="font-size:10px"></i>', iconSize:[16,16]});
                L.marker(camPt, {icon:camIcon}).addTo(this.map).bindPopup("PTZ-102");
            }
            
            updateMapInspectionMarker(latlng) {
                if(this.state.mapInspectMarker) this.map.removeLayer(this.state.mapInspectMarker);
                const icon = L.divIcon({className:'pulse-icon', iconSize:[20,20]});
                this.state.mapInspectMarker = L.marker(latlng, {icon:icon}).addTo(this.map);
            }
            
            updateMapMarkers() { /* ... */ }

            // --- SCHEMATIC RENDER ---
            drawSchematic() {
                const w = this.canvas.width; const h = this.canvas.height; const ctx = this.ctx;
                ctx.clearRect(0,0,w,h);
                const marginX = 60; const usableW = w - marginX*2; const centerY = h/2;
                
                const grad = ctx.createLinearGradient(0, centerY-100, 0, centerY+100);
                grad.addColorStop(0,'#0a0a0a'); grad.addColorStop(0.5,'#151515'); grad.addColorStop(1,'#0a0a0a');
                ctx.fillStyle = grad; ctx.fillRect(0, centerY-80, w, 160);

                const spacing = 14; const startY = centerY - (12*spacing)/2 + spacing/2;
                
                CABLE_CONFIG.forEach((fib, i) => {
                    const y = startY + i*spacing;
                    const hasSplit = this.state.events.some(e => e.fiberIdx === i && e.type === 'splitter');
                    
                    ctx.beginPath();
                    if (hasSplit) {
                        ctx.moveTo(0, centerY); ctx.bezierCurveTo(marginX, centerY, marginX, y, marginX+60, y); ctx.lineTo(w-marginX-60, y);
                    } else {
                        ctx.moveTo(0, centerY); ctx.bezierCurveTo(marginX, centerY, marginX, y, marginX+60, y); ctx.lineTo(w-marginX-60, y);
                    }
                    ctx.bezierCurveTo(w-marginX, y, w-marginX, centerY, w, centerY);

                    const isActive = (i === this.state.activeFiberIndex);
                    ctx.lineWidth = isActive ? 2 : 1;
                    ctx.strokeStyle = fib.hex;
                    ctx.globalAlpha = isActive ? 1 : 0.3;
                    if(isActive) { ctx.shadowColor=fib.hex; ctx.shadowBlur=10; } else { ctx.shadowBlur=0; }
                    ctx.stroke(); ctx.globalAlpha = 1; ctx.shadowBlur = 0;
                });

                if (this.state.lockedPoint) {
                    const px = marginX + (this.state.lockedPoint.km / this.state.dist) * usableW;
                    const fy = startY + this.state.lockedPoint.fiberIndex * spacing;
                    ctx.beginPath(); ctx.moveTo(px, centerY-90); ctx.lineTo(px, centerY+90);
                    ctx.strokeStyle = '#00bcd4'; ctx.lineWidth = 1; ctx.setLineDash([4,4]); ctx.stroke(); ctx.setLineDash([]);
                    ctx.beginPath(); ctx.arc(px, fy, 4, 0, Math.PI*2); ctx.fillStyle = '#00bcd4'; ctx.fill();
                }
                
                this.state.events.forEach(ev => {
                    const ex = marginX + (ev.km / this.state.dist) * usableW;
                    const fy = startY + ev.fiberIdx * spacing;
                    let icon = '\uf00d'; let color = '#fff';
                    if (ev.type === 'amp') { color='#00bcd4'; icon='\uf04b'; }
                    else if (ev.type === 'splitter') { color='#a855f7'; icon='\uf1e0'; }
                    else if (ev.type === 'splice') { color='#ff9800'; icon='\uf00d'; }
                    else { color='#ccc'; icon='\uf7a4'; }
                    ctx.fillStyle = color; ctx.font='10px FontAwesome'; ctx.textAlign='center'; ctx.textBaseline='middle';
                    ctx.fillText(icon, ex, fy);
                });
            }

            // --- OTDR (Updated for Range) ---
            updateOTDR() {
                if(!this.chart) return;
                const fiber = CABLE_CONFIG[this.state.activeFiberIndex];
                this.chart.data.datasets[0].borderColor = fiber.hex;
                this.chart.data.datasets[0].backgroundColor = (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0,0,0,200); g.addColorStop(0, fiber.hex+'33'); g.addColorStop(1, fiber.hex+'00'); return g;
                };
                
                const maxX = this.otdrRanges[this.state.otdr.rangeIdx];
                this.chart.options.scales.x.max = maxX;
                
                if (this.state.otdr.zoom && this.state.lockedPoint) {
                    const c = this.state.lockedPoint.km; const s = maxX * 0.05;
                    this.chart.options.scales.x.min = Math.max(0, c-s); this.chart.options.scales.x.max = Math.min(this.state.dist, c+s);
                    const p = this.calcPowerAt(c, this.state.activeFiberIndex);
                    this.chart.options.scales.y.min = p-3; this.chart.options.scales.y.max = p+3;
                } else {
                    this.chart.options.scales.x.min = 0; this.chart.options.scales.y.min = -65; this.chart.options.scales.y.max = 15;
                }

                const data = []; const steps = 400; const points = [0, this.state.dist];
                this.state.events.filter(e => e.fiberIdx === this.state.activeFiberIndex).forEach(e => points.push(e.km));
                for(let i=0; i<=steps; i++) points.push((i/steps)*this.state.dist);
                const sorted = [...new Set(points)].sort((a,b)=>a-b);
                
                sorted.forEach(km => {
                    if(km>0) data.push({x:km, y:this.calcPowerAt(km-0.001, this.state.activeFiberIndex)});
                    data.push({x:km, y:this.calcPowerAt(km, this.state.activeFiberIndex)});
                });
                
                this.chart.data.datasets[0].data = data;
                
                if (this.state.otdr.showEvents) {
                    const activeEvents = this.state.events.filter(e => e.fiberIdx === this.state.activeFiberIndex);
                    this.chart.data.datasets[0].pointRadius = (ctx) => {
                        const val = ctx.raw; if (!val) return 0;
                        const isEvent = activeEvents.some(e => Math.abs(e.km - val.x) < 0.01);
                        return isEvent ? 4 : 0;
                    };
                    this.chart.data.datasets[0].pointBackgroundColor = '#ff9800';
                } else { this.chart.data.datasets[0].pointRadius = 0; }

                this.chart.update();
            }

            // --- STANDARD ---
            setText(id, t) { const e = document.getElementById(id); if(e) e.innerText=t; }
            setHTML(id, h) { const e = document.getElementById(id); if(e) e.innerHTML=h; }
            setStyle(id, p, v) { const e = document.getElementById(id); if(e) e.style[p]=v; }
            
            inspectFiber(km, idx) {
                this.state.lockedPoint = { km, fiberIndex: idx };
                this.state.activeFiberIndex = idx;
                const hud = document.getElementById('hud-meter');
                if(hud) { hud.classList.remove('hidden','opacity-0','translate-y-2'); hud.classList.add('pointer-events-auto'); }
                
                const f = CABLE_CONFIG[idx]; const s = SERVICES[f.svc];
                this.setStyle('hud-fiber-name','color',f.hex); this.setStyle('hud-fiber-color','backgroundColor',f.hex);
                this.setText('hud-fiber-id', `HILO ${f.id} (${f.colorName})`);
                this.setText('hud-service', s.name);
                this.setText('hud-dist', km.toFixed(3)+' km');
                
                this.setText('panel-fiber-id', `Hilo ${f.id}`); this.setStyle('panel-fiber-id','color',f.hex);
                this.setText('panel-service', s.name); this.setText('panel-lambda', s.lambda+' nm');
                this.setText('panel-coef', (s.attenuation+this.state.globalDegradation).toFixed(2)+' dB/km');
                
                this.refreshHUDDisplay();
                this.updateOTDR(); this.drawSchematic();
            }

            closeHUD() {
                const hud = document.getElementById('hud-meter'); if(hud) hud.classList.add('hidden');
                this.state.lockedPoint = null;
                if(this.state.mapInspectMarker) { this.map.removeLayer(this.state.mapInspectMarker); this.state.mapInspectMarker = null; }
                this.drawSchematic();
            }

            // Interaction
            bindInputs() {
                const rs = () => { this.canvas.width = this.container.clientWidth; this.canvas.height = this.container.clientHeight; this.drawSchematic(); };
                window.addEventListener('resize', rs); rs();
                this.canvas.addEventListener('click', (e) => {
                    const r = this.canvas.getBoundingClientRect();
                    const x = e.clientX - r.left; const y = e.clientY - r.top;
                    const mx = 60; const uw = this.canvas.width - mx*2;
                    let km = ((x-mx)/uw)*this.state.dist; if(km<0) km=0; if(km>this.state.dist) km=this.state.dist;
                    
                    const cy = this.canvas.height/2; const sp = 14; const startY = cy - (12*sp)/2 + sp/2;
                    let fIdx = Math.round((y-startY)/sp); if(fIdx<0) fIdx=0; if(fIdx>11) fIdx=11;
                    
                    if(this.state.tool==='cursor') {
                        const hit = this.state.events.find(ev => Math.abs(ev.km-km)<0.5 && ev.fiberIdx===fIdx);
                        if(hit) this.selectEvent(hit.id); else this.inspectFiber(km, fIdx);
                    } else this.addEvent(km, this.state.tool, fIdx);
                });
                
                document.getElementById('param-dist').addEventListener('change', (e) => { this.state.dist = parseFloat(e.target.value); this.updateOTDR(); });
                document.getElementById('param-tx').addEventListener('change', (e) => { this.state.baseTx = parseFloat(e.target.value); this.updateOTDR(); });
                document.getElementById('param-deg').addEventListener('change', (e) => { this.state.globalDegradation = parseFloat(e.target.value); this.updateOTDR(); });
            }

            // Event Mgmt
            addEvent(km, type, fIdx) {
                let v = 0.1; if(type==='connector') v=0.5; if(type==='splitter') v=10.5; if(type==='amp') v=20;
                const ev = { id:Date.now(), km, type, val:v, fiberIdx:fIdx };
                this.state.events.push(ev); this.state.events.sort((a,b)=>a.km-b.km);
                this.refreshUI(); this.showToast("Componente añadido", "success");
            }
            selectEvent(id) {
                this.state.selectedEventId = id; const p = document.getElementById('prop-panel'); this.closeHUD();
                if(id) {
                    const e = this.state.events.find(x=>x.id===id); p.classList.remove('hidden');
                    this.setText('edit-type', e.type.toUpperCase()); document.getElementById('prop-km').value=e.km.toFixed(2); document.getElementById('prop-val').value=e.val;
                } else p.classList.add('hidden');
                this.drawSchematic();
            }
            updateSelected() {
                const e = this.state.events.find(x=>x.id===this.state.selectedEventId);
                if(e) { e.km = parseFloat(document.getElementById('prop-km').value); e.val = parseFloat(document.getElementById('prop-val').value); }
                this.refreshUI();
            }
            deleteSelected() {
                this.state.events = this.state.events.filter(x=>x.id!==this.state.selectedEventId);
                this.selectEvent(null); this.refreshUI();
            }
            resetEvents() { this.state.events=[]; this.selectEvent(null); this.refreshUI(); }
            
            refreshUI() {
                const l = document.getElementById('events-list'); l.innerHTML='';
                this.setText('event-count', this.state.events.length);
                this.state.events.forEach(ev => {
                    const f = CABLE_CONFIG[ev.fiberIdx];
                    const d = document.createElement('div'); d.className = `text-[10px] p-2 rounded border border-cad-border bg-[#111] cursor-pointer hover:border-cad-accent flex justify-between ${ev.id===this.state.selectedEventId?'border-cad-accent':''}`;
                    d.innerHTML = `<span style="color:${f.hex}">${ev.type.toUpperCase()}</span> <span>${ev.km.toFixed(2)}km</span>`;
                    d.onclick = () => this.selectEvent(ev.id); l.appendChild(d);
                });
                this.drawSchematic(); this.updateOTDR();
            }

            setTool(t) {
                this.state.tool = t;
                document.querySelectorAll('.cad-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tool-'+t).classList.add('active');
                this.updateToolPanel();
            }

            // OPM Logic
            opmCycleLambda() { this.state.opm.lambdaIdx = (this.state.opm.lambdaIdx + 1) % OPM_LAMBDAS.length; this.refreshHUDDisplay(); }
            opmSetRef() { if(!this.state.lockedPoint) return; this.state.opm.ref = this.calculateFinalPower(); this.flashScreen("REF"); this.refreshHUDDisplay(); }
            opmSave() { if(!this.state.lockedPoint) return; this.flashScreen("SAVED"); this.showToast("Medición guardada", "success"); }
            flashScreen(txt) { const s=document.getElementById('opm-lcd'); const m=document.getElementById('opm-msg'); s.classList.add('flash'); if(m){ m.innerText=txt; m.style.display='block'; setTimeout(()=>{ s.classList.remove('flash'); m.style.display='none'; },1000); } }
            
            calculateFinalPower() {
                if(!this.state.lockedPoint) return -99;
                const svc = SERVICES[CABLE_CONFIG[this.state.lockedPoint.fiberIndex].svc];
                const real = this.calcPowerAt(this.state.lockedPoint.km, this.state.lockedPoint.fiberIndex);
                const man = OPM_LAMBDAS[this.state.opm.lambdaIdx];
                if(man==='AUTO') return real;
                if(svc.lambda>0 && man!==svc.lambda) return -60;
                return real;
            }
            refreshHUDDisplay() {
                if(!this.state.lockedPoint) return;
                const man = OPM_LAMBDAS[this.state.opm.lambdaIdx];
                this.setText('hud-lambda', man==='AUTO'?'AUTO':man+'nm');
                const val = this.calculateFinalPower();
                let dVal = val;
                if(this.state.opm.ref!==null) { dVal=val-this.state.opm.ref; this.setText('hud-unit','dB'); this.setText('hud-mode','REL'); this.setText('hud-ref-val', this.state.opm.ref.toFixed(2)); }
                else { this.setText('hud-unit','dBm'); this.setText('hud-mode','ABS'); this.setText('hud-ref-val','--'); }
                
                if(val<=-60) this.setText('hud-pwr','LO'); else this.setText('hud-pwr', dVal.toFixed(2));
                const e = document.getElementById('hud-pwr');
                if(e) {
                    if(val<-28) e.className="text-4xl font-bold tracking-widest text-red-500 font-digital";
                    else if(val>-8) e.className="text-4xl font-bold tracking-widest text-yellow-500 font-digital";
                    else e.className="text-4xl font-bold tracking-widest text-green-400 font-digital";
                }
            }

            // OTDR Controls
            otdrAuto() { this.state.otdr.rangeIdx=2; this.state.otdr.zoom=false; this.updateOTDR(); this.showToast("Escala Auto"); }
            otdrRange() { this.state.otdr.rangeIdx = (this.state.otdr.rangeIdx+1)%this.otdrRanges.length; this.updateOTDR(); this.showToast("Rango: "+this.otdrRanges[this.state.otdr.rangeIdx]+"km"); }
            otdrZoom() { this.state.otdr.zoom = !this.state.otdr.zoom; document.getElementById('otdr-zoom-badge').style.display = this.state.otdr.zoom?'block':'none'; this.updateOTDR(); }
            otdrEvents() { this.state.otdr.showEvents = !this.state.otdr.showEvents; this.updateOTDR(); }

            // Export
            exportReport() {
                const report = { project: "LIMA_DORSAL", date: new Date().toLocaleString(), events: this.state.events };
                const ws = XLSX.utils.json_to_sheet(this.state.events);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, "FiberLink_Report.xlsx");
                this.showToast("Excel Exportado", "success");
            }
            showToast(msg, type='info') {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div'); t.className='toast'; t.innerHTML=`<span>${msg}</span>`;
                if(type==='success') t.style.borderLeftColor='#4caf50';
                c.appendChild(t); setTimeout(()=>{ t.remove() },3000);
            }

            // Init Helpers
            initOTDR() {
                const ctx = document.getElementById('otdrChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets: [{ label: 'dBm', borderColor: '#00bcd4', borderWidth: 2, pointRadius: 0, fill: 'start', backgroundColor: 'rgba(0,188,212,0.1)', data: [] }] },
                    options: { 
                        responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: {display:false} },
                        scales: { x: { grid: {color:'#222'}, ticks:{color:'#666'}, title: { display: true, text: 'Distancia (km)', color: '#888', font: { size: 10 } } }, y: { grid:{color:'#222'}, ticks:{color:'#666'}, min:-65, max:15, title: { display: true, text: 'Potencia (dBm)', color: '#888', font: { size: 10 } } } }
                    }
                });
            }
            initCrossSection() {
                const cvs = document.getElementById('cross-section-canvas'); const ctx = cvs.getContext('2d'); const dpr = window.devicePixelRatio || 1;
                cvs.width = 120*dpr; cvs.height = 120*dpr; ctx.scale(dpr,dpr);
                ctx.beginPath(); ctx.arc(60,60,50,0,Math.PI*2); ctx.fillStyle='#222'; ctx.fill(); ctx.strokeStyle='#444'; ctx.stroke();
                CABLE_CONFIG.forEach((f,i)=>{
                    const a = (i/12)*Math.PI*2; const x=60+35*Math.cos(a); const y=60+35*Math.sin(a);
                    ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fillStyle=f.hex; ctx.fill();
                });
            }

            // ... (AI logic remains) ...
            toggleAI() { const p = document.getElementById('ai-panel'); p.classList.toggle('open'); }
            // ... (askGemini / callGemini logic same as previous) ...
             getSystemContext() {
                const context = {
                    totalLength: this.state.dist,
                    baseTxPower: this.state.baseTx,
                    attenuationBase: 0.25 + this.state.globalDegradation, 
                    totalEvents: this.state.events.length,
                    eventList: this.state.events.map(e => ({
                        type: e.type,
                        km: e.km.toFixed(2),
                        loss_gain: e.val,
                        fiberIndex: e.fiberIdx
                    })),
                    activeFiber: {
                        index: this.state.activeFiberIndex,
                        config: CABLE_CONFIG[this.state.activeFiberIndex],
                        service: SERVICES[CABLE_CONFIG[this.state.activeFiberIndex].svc]
                    }
                };
                return JSON.stringify(context);
            }

            async askGemini(predefinedPrompt = null) {
                const inputEl = document.getElementById('ai-input');
                const chatContent = document.getElementById('ai-chat-content');
                const userQuery = predefinedPrompt || inputEl.value;

                if (!userQuery.trim()) return;

                const userMsg = document.createElement('div');
                userMsg.className = 'ai-message user';
                userMsg.innerText = userQuery;
                chatContent.appendChild(userMsg);
                
                inputEl.value = '';
                chatContent.scrollTop = chatContent.scrollHeight;

                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'ai-message bot ai-typing';
                chatContent.appendChild(loadingMsg);

                const contextData = this.getSystemContext();
                const systemPrompt = `
                    Actúa como un Ingeniero Senior de Fibra Óptica experto.
                    Estás analizando una simulación de red en tiempo real.
                    
                    DATOS TÉCNICOS ACTUALES (JSON):
                    ${contextData}
                    
                    Instrucciones CRÍTICAS:
                    1. Sé EXTREMADAMENTE BREVE y PRECISO. Máximo 2-3 frases si es posible.
                    2. Ve directo al grano. Evita introducciones o saludos largos.
                    3. Usa terminología técnica (dBm, EDFA, Splitter).
                    4. Si hay problemas, indica la causa raíz inmediatamente.
                    5. Responde siempre en español.
                `;

                try {
                    const response = await this.callGemini(systemPrompt + "\n\nUser Question: " + userQuery);
                    chatContent.removeChild(loadingMsg);
                    const botMsg = document.createElement('div');
                    botMsg.className = 'ai-message bot';
                    botMsg.innerHTML = marked.parse(response);
                    chatContent.appendChild(botMsg);
                    chatContent.scrollTop = chatContent.scrollHeight;
                } catch (error) {
                    console.error("AI Error:", error);
                    chatContent.removeChild(loadingMsg);
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'ai-message bot text-red-400';
                    errorMsg.innerText = "Error de comunicación con la IA.";
                    chatContent.appendChild(errorMsg);
                }
            }

            async callGemini(prompt) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const delays = [1000, 2000, 4000];
                for (let i = 0; i <= delays.length; i++) {
                    try {
                        const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                    } catch (err) {
                        if (i === delays.length) throw err;
                        await new Promise(res => setTimeout(res, delays[i]));
                    }
                }
            }

            loop() { requestAnimationFrame(() => this.loop()); }
        }

        window.onload = () => { window.app = new FiberEngine(); };

    </script>
</body>
</html>