<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiberLink ENG Suite | Link Budget Calculator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Pro -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet & Esri Leaflet (GIS Satelital) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

    <!-- Chart.js para OTDR -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cad-bg': '#0a0a0a',
                        'cad-panel': '#151515',
                        'cad-border': '#2a2a2a',
                        'cad-accent': '#00bcd4', 
                        'cad-warning': '#ff9800',
                        'cad-danger': '#f44336',
                        'cad-success': '#4caf50',
                        'device-yellow': '#f59e0b',
                        'lcd-bg': '#2b3a2a',
                        'lcd-text': '#4ade80'
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        digital: ['Share Tech Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #e0e0e0; overflow: hidden; }
        
        /* INSTRUMENTOS */
        .opm-device {
            background: #1a1a1a; border: 4px solid #f59e0b; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.8), inset 0 0 10px rgba(0,0,0,0.5);
            width: 340px; /* Wider for math */
            position: absolute; z-index: 9999; overflow: hidden;
        }
        .opm-screen {
            background: #36423b;
            background-image: linear-gradient(180deg, rgba(0,0,0,0.1) 50%, rgba(255,255,255,0.05) 50%);
            background-size: 100% 4px; border: 2px inset #111; border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            font-family: 'Share Tech Mono', monospace; color: #d1fae5; text-shadow: 0 0 5px #4ade80;
            padding: 10px; margin: 10px; position: relative;
        }
        .flash { animation: screen-flash 0.3s ease-out; }
        @keyframes screen-flash {
            0% { background-color: #36423b; }
            50% { background-color: #86efac; color: #000; text-shadow: none; }
            100% { background-color: #36423b; }
        }

        .opm-button {
            width: 30px; height: 30px; border-radius: 50%;
            background: linear-gradient(145deg, #333, #222);
            box-shadow: 2px 2px 5px #111, -1px -1px 2px #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #888; border: 1px solid #000; cursor: pointer; transition: all 0.1s;
        }
        .opm-button:active { box-shadow: inset 2px 2px 5px #111; transform: scale(0.95); }

        .otdr-frame {
            background: #202020; border-top: 4px solid #333; border-right: 4px solid #333;
            border-radius: 8px 8px 0 0; box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
            display: flex; flex-direction: column; height: 100%;
        }
        
        .otdr-key {
            height: 100%; width: 4rem;
            background: linear-gradient(180deg, #333, #222);
            border: 1px solid #000; border-radius: 4px;
            color: #888; font-size: 9px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.1s;
        }
        .otdr-key:active { background: #111; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transform: translateY(1px); }
        .otdr-key:hover { color: #fff; border-color: #555; }

        .scope-bezel {
            width: 160px; height: 160px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #444, #111);
            border: 4px solid #000; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; position: relative;
        }
        .scope-overlay {
            position: absolute; inset: 0; border-radius: 50%;
            background: url('data:image/svg+xml;utf8,<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg"><circle cx="50%" cy="50%" r="40%" stroke="rgba(0,255,0,0.3)" stroke-width="1" fill="none"/><line x1="50%" y1="0" x2="50%" y2="100%" stroke="rgba(0,255,0,0.3)" stroke-width="1"/><line x1="0" y1="50%" x2="100%" y2="50%" stroke="rgba(0,255,0,0.3)" stroke-width="1"/></svg>');
            pointer-events: none; z-index: 10;
        }

        .cad-btn { @apply flex flex-col items-center justify-center w-full py-3 px-1 text-[10px] uppercase tracking-wider font-bold text-gray-500 bg-cad-panel border-l-2 border-transparent hover:bg-[#222] hover:text-white transition-all mb-2; }
        .cad-btn.active { @apply bg-[#1a1a1a] text-cad-accent border-cad-accent shadow-[inset_5px_0_10px_rgba(0,188,212,0.1)]; }
        .cad-input { width: 100%; background-color: #080808 !important; border: 1px solid #333 !important; color: #00bcd4 !important; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 6px 8px; outline: none; border-radius: 2px; }
        .cad-label { @apply text-[9px] text-gray-500 uppercase font-bold mb-1 block tracking-wider; }

        .leaflet-container { background: #050505; }
        
        .icon-pole { background: #666; border: 1px solid #aaa; border-radius: 50%; box-shadow: 2px 2px 5px rgba(0,0,0,0.8); }
        .icon-mufa { background: #333; border: 2px solid #ff9800; border-radius: 4px; }
        .icon-nap { background: #000; border: 2px solid #fff; border-radius: 2px; box-shadow: 0 0 5px black; }
        .icon-camera { background: #9c27b0; border: 1px solid #fff; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 10px; }

        .pulse-icon { border-radius: 50%; border: 2px solid #00bcd4; background: rgba(0, 188, 212, 0.4); box-shadow: 0 0 15px #00bcd4; animation: pulse-animation 1.5s infinite; }
        @keyframes pulse-animation { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

        .toast { background: #1a1a1a; border-left: 4px solid #00bcd4; color: white; padding: 12px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out forwards; font-size: 12px; display: flex; align-items: center; gap: 10px; border: 1px solid #333; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .zoom-indicator { position: absolute; top: 5px; right: 5px; background: rgba(0,188,212,0.2); border: 1px solid #00bcd4; color: #00bcd4; font-size: 9px; padding: 2px 4px; border-radius: 2px; display: none; }
        #opm-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #4ade80; color: #000; padding: 2px 5px; font-weight: bold; display: none; pointer-events: none; }

        #ai-panel { box-shadow: -5px 0 30px rgba(0,0,0,0.8); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #ai-panel.open { transform: translateX(0); }
        .ai-message { @apply mb-2 p-2 rounded text-xs leading-snug; }
        .ai-message.user { @apply bg-[#2a2a2a] text-white border border-gray-700 ml-4; }
        .ai-message.bot { @apply bg-indigo-900/20 text-gray-300 border-l-2 border-indigo-500 mr-2 rounded-l-none pl-3; }
        .ai-message.bot strong { @apply text-indigo-300; }
        .ai-typing::after { content: '...'; animation: ellipsis 1.5s infinite; }
        @keyframes ellipsis { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }
        
        /* Math Panel */
        .math-panel { background: rgba(0,0,0,0.5); border-radius: 4px; padding: 5px; margin-top: 5px; font-size: 9px; border: 1px dashed #555; }
        .math-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .math-header { text-align: center; color: #f59e0b; font-weight: bold; border-bottom: 1px solid #444; margin-bottom: 4px; padding-bottom: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans text-sm bg-black overflow-hidden">

    <!-- HEADER -->
    <header class="h-12 bg-cad-panel border-b border-cad-border flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-cad-accent">
                <i class="fa-solid fa-network-wired text-xl"></i>
                <div class="flex flex-col">
                    <span class="font-bold tracking-widest text-sm leading-none">FIBER<span class="text-white">LINK</span></span>
                    <span class="text-[9px] text-gray-500 font-mono tracking-widest">CALCULADORA DE ENLACE</span>
                </div>
            </div>
            <div class="h-6 w-px bg-cad-border mx-2"></div>
            <div class="flex flex-col">
                <span class="text-[9px] text-gray-500 uppercase">Proyecto</span>
                <span class="text-xs font-mono text-gray-300">LIMA METRO DORSAL</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="text-right mr-4 hidden md:block">
                <span class="block text-[9px] text-gray-500 uppercase">Enlace</span>
                <span id="header-status" class="text-xs font-bold text-cad-success bg-green-900/20 px-2 py-0.5 rounded border border-green-900/50">OPERATIVO</span>
            </div>
            <button onclick="app.toggleAI()" class="flex items-center gap-2 bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-300 border border-indigo-500/50 px-3 py-1.5 rounded transition-all group">
                <i class="fa-solid fa-microchip text-indigo-400 group-hover:text-white transition-colors"></i>
                <span class="text-xs font-bold">Copiloto</span>
            </button>
            <button onclick="app.exportReport()" class="bg-[#222] hover:bg-[#333] text-white px-3 py-1.5 rounded text-xs border border-gray-700 transition flex items-center gap-2">
                <i class="fa-solid fa-file-excel text-green-500"></i>Exportar
            </button>
        </div>
    </header>

    <!-- WORKSPACE -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- TOOLBAR -->
        <aside class="w-20 bg-[#0c0c0c] border-r border-cad-border flex flex-col items-center py-2 z-40 overflow-y-auto shrink-0">
            <div class="text-[8px] text-gray-600 font-bold mb-2 uppercase tracking-widest w-full text-center">Inspección</div>
            <button onclick="app.setTool('cursor')" id="tool-cursor" class="cad-btn active" title="Cursor"><i class="fa-solid fa-arrow-pointer"></i><span>Cursor</span></button>
            
            <div class="h-px w-10 bg-cad-border my-1"></div>
            <div class="text-[8px] text-gray-600 font-bold mb-2 uppercase tracking-widest w-full text-center">Pasivos</div>
            <button onclick="app.setTool('splice')" id="tool-splice" class="cad-btn"><i class="fa-solid fa-xmarks-lines text-orange-500"></i><span>Empalme</span></button>
            <button onclick="app.setTool('connector')" id="tool-connector" class="cad-btn"><i class="fa-solid fa-grip-lines-vertical text-gray-300"></i><span>Conector</span></button>
            <button onclick="app.setTool('splitter')" id="tool-splitter" class="cad-btn"><i class="fa-solid fa-share-nodes text-purple-400"></i><span>Splitter</span></button>
            
            <div class="h-px w-10 bg-cad-border my-1"></div>
            <div class="text-[8px] text-gray-600 font-bold mb-2 uppercase tracking-widest w-full text-center">Activos</div>
            <button onclick="app.setTool('amp')" id="tool-amp" class="cad-btn"><i class="fa-solid fa-caret-right text-green-500"></i><span>EDFA</span></button>
            
            <div class="mt-auto w-full px-2 pb-2">
                <button onclick="app.toggleView()" class="w-full bg-blue-900/30 text-blue-400 border border-blue-800 rounded py-2 hover:bg-blue-900/50 transition"><i class="fa-solid fa-map-location-dot"></i></button>
            </div>
        </aside>

        <!-- MAIN VIEW -->
        <div class="flex-1 flex flex-col relative bg-[#050505] overflow-hidden">
            
            <!-- OPM HUD (Calculadora) -->
            <div id="hud-meter" class="opm-device hidden transition-all duration-200 top-6 right-6">
                <div class="flex justify-between items-center px-3 py-2 bg-[#222] border-b border-[#333]">
                    <span class="text-[10px] font-bold text-gray-400 tracking-widest">OPM-300 PRO</span>
                    <i class="fa-solid fa-battery-full text-green-500 text-xs"></i>
                </div>
                <div class="opm-screen" id="opm-lcd">
                    <div class="flex justify-between items-end border-b border-white/10 pb-1 mb-2">
                        <span id="hud-lambda" class="text-sm text-yellow-300">1550nm</span>
                        <span id="hud-mode" class="text-[9px] uppercase tracking-widest">ABS</span>
                    </div>
                    
                    <div id="math-display" class="math-panel hidden">
                        <!-- Populated by JS -->
                    </div>

                    <div class="text-center py-2 relative">
                        <div id="hud-pwr" class="text-4xl font-bold tracking-widest">-00.00</div>
                        <div id="hud-unit" class="text-sm text-gray-400">dBm</div>
                        <div id="opm-msg" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#4ade80;color:#000;padding:2px 5px;">SAVED</div>
                    </div>
                </div>
                <div class="px-4 pb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] text-gray-500 uppercase font-bold">Ubicación</span>
                        <span id="hud-dist" class="text-xs font-mono text-white bg-black px-2 py-0.5 rounded border border-gray-700">-- km</span>
                    </div>
                </div>
                <div class="bg-[#111] p-3 flex justify-around border-t border-[#333]">
                    <div class="opm-button" onclick="app.opmSave()" title="Guardar"><i class="fa-solid fa-floppy-disk"></i></div>
                    <div class="opm-button" onclick="app.opmCycleLambda()" title="Lambda"><i class="fa-solid fa-wave-square"></i></div>
                    <div class="opm-button text-red-500 border-red-900" title="Cerrar" onclick="app.closeHUD()"><i class="fa-solid fa-power-off"></i></div>
                </div>
            </div>

            <!-- MAP LAYER -->
            <div id="map-layer" class="absolute inset-0 z-10 hidden"></div>

            <!-- SCHEMATIC LAYER -->
            <div id="schematic-layer" class="absolute inset-0 z-20 flex flex-col">
                <div id="schematic-container" class="flex-1 relative border-b border-cad-border bg-[#080808] cursor-crosshair">
                    <canvas id="fiberCanvas" class="relative z-10"></canvas>
                </div>
                
                <!-- INSTRUMENTS BOTTOM -->
                <div class="h-64 bg-[#111] border-t border-cad-border flex shrink-0 p-1 gap-1">
                    <!-- OTDR -->
                    <div class="flex-1 bg-[#202020] border-t-4 border-r-4 border-[#333] rounded-t-lg flex flex-col">
                        <div class="h-6 bg-[#2a2a2a] px-3 flex items-center justify-between border-b border-black">
                            <span class="text-[9px] font-bold text-gray-300 tracking-widest">OTDR TRACE</span>
                            <span class="text-[8px] text-gray-500">REAL-TIME</span>
                        </div>
                        <div class="flex-1 p-2 bg-black relative">
                            <div class="h-full w-full border border-gray-800 rounded bg-[#050505] p-2 relative overflow-hidden" style="min-height: 150px;">
                                <canvas id="otdrChart" style="width:100%; height:100%;"></canvas>
                            </div>
                            <div id="otdr-zoom-badge" class="zoom-indicator">ZOOM ACTIVE</div>
                        </div>
                        <div class="h-8 bg-[#181818] flex justify-center gap-1 p-1">
                            <div class="otdr-key" onclick="app.otdrAuto()">AUTO</div>
                            <div class="otdr-key" onclick="app.otdrRange()">RANGE</div>
                            <div class="otdr-key" onclick="app.otdrZoom()">ZOOM</div>
                            <div class="otdr-key" onclick="app.otdrEvents()">EVENTS</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <aside class="w-72 bg-cad-panel border-l border-cad-border flex flex-col z-30 shadow-2xl shrink-0">
            <div class="p-4 border-b border-cad-border bg-[#181818]">
                <span class="text-[9px] text-cad-accent uppercase font-bold">Herramienta</span>
                <div class="flex items-center gap-2 text-white mt-1">
                    <i id="tool-icon-display" class="fa-solid fa-arrow-pointer"></i>
                    <span id="tool-name-display" class="font-bold text-sm">CURSOR</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-6">
                <div class="space-y-3">
                    <div class="flex justify-between"><span class="cad-label">Parámetros</span></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="text-[9px] text-gray-500">Longitud (km)</span><input type="number" id="param-dist" value="80.0" class="cad-input text-right"></div>
                        <div><span class="text-[9px] text-gray-500">Tx (dBm)</span><input type="number" id="param-tx" value="3.0" class="cad-input text-right"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="text-[9px] text-gray-500">Atenuación (dB/km)</span><input type="number" id="param-att" value="0.25" step="0.01" class="cad-input text-right"></div>
                        <div><span class="text-[9px] text-gray-500">Margen (dB)</span><input type="number" id="param-margin" value="3.0" step="0.1" class="cad-input text-right"></div>
                    </div>
                </div>
                <div class="h-px bg-[#222]"></div>
                <!-- Fiber Info -->
                <div class="bg-[#111] p-3 rounded border border-cad-border">
                    <span class="cad-label text-cad-accent mb-2">Hilo Activo</span>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex justify-between"><span class="text-gray-500">ID</span><span id="panel-fiber-id" class="text-white">--</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Servicio</span><span id="panel-service" class="text-white font-bold">--</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Atenuación</span><span id="panel-coef" class="text-gray-300">--</span></div>
                    </div>
                </div>
                <div class="h-px bg-[#222]"></div>
                <!-- Events -->
                <div>
                    <div class="flex justify-between items-center mb-2"><span class="cad-label">Eventos</span><span id="event-count" class="text-[9px] bg-[#222] text-white px-2 rounded">0</span></div>
                    <div id="events-list" class="space-y-1 max-h-40 overflow-y-auto">
                        <div class="text-center py-2 text-gray-600 italic text-[10px]">Vacío</div>
                    </div>
                </div>
                <!-- Editor -->
                <div id="prop-panel" class="hidden bg-[#1a1a1a] p-3 rounded border border-cad-accent/30 shadow-lg">
                    <div class="flex justify-between mb-2"><span class="text-xs font-bold text-white">Editar</span><span id="edit-type" class="text-[9px] bg-black px-1 rounded text-gray-400">TYPE</span></div>
                    <div class="space-y-2">
                        <input id="prop-km" type="number" step="0.01" class="cad-input" placeholder="KM">
                        <input id="prop-val" type="number" step="0.1" class="cad-input" placeholder="dB">
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="app.updateSelected()" class="bg-cad-accent text-black text-[10px] font-bold py-1 rounded">GUARDAR</button>
                            <button onclick="app.deleteSelected()" class="bg-red-900/30 text-red-400 border border-red-900/50 text-[10px] font-bold py-1 rounded">BORRAR</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-2 border-t border-cad-border text-center bg-[#0a0a0a]">
                <button onclick="app.resetEvents()" class="text-[9px] text-red-600 hover:text-red-400 uppercase font-bold">RESETEAR TODO</button>
            </div>
        </aside>

        <!-- TOASTS -->
        <div id="toast-container" class="fixed bottom-4 right-4 z-[10000] flex flex-col gap-2"></div>

        <!-- AI COPILOT -->
        <div id="ai-panel" class="absolute top-0 right-0 w-80 h-full bg-[#151515] border-l border-cad-border z-50 flex flex-col">
            <div class="h-12 bg-indigo-900/30 border-b border-indigo-500/30 flex items-center justify-between px-4">
                <div class="flex items-center gap-2 text-indigo-400"><i class="fa-solid fa-robot"></i><span class="font-bold text-sm">Copiloto</span></div>
                <button onclick="app.toggleAI()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="ai-chat-content" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="ai-message bot">Hola. Analizo tu red en tiempo real.</div>
            </div>
            <div class="p-3 bg-[#0a0a0a] border-t border-cad-border">
                <div class="flex gap-2">
                    <input type="text" id="ai-input" class="flex-1 bg-[#1a1a1a] border border-gray-700 rounded px-2 py-1 text-xs text-white" placeholder="Pregunta algo..." onkeypress="if(event.key === 'Enter') app.askGemini()">
                    <button onclick="app.askGemini()" class="bg-indigo-600 text-white w-8 h-8 rounded flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG - 0.25 dB/km STANDARDIZED
        const SERVICES = {
            INTERNET: { name: 'INTERNET (GPON)', lambda: 1550, color: '#00bcd4' },
            TV:       { name: 'TV CABLE (RF)',   lambda: 1550, color: '#e91e63' },
            PHONE:    { name: 'TELEFONÍA (VoIP)',lambda: 1550, color: '#ffeb3b' },
            CCTV:     { name: 'CCTV SEGURIDAD',  lambda: 1550, color: '#9c27b0' },
            DARK:     { name: 'FIBRA OSCURA',    lambda: 0,    color: '#333333' }
        };
        const CABLE_CONFIG = [
            { id: 1, colorName: 'Azul',    hex: '#0074D9', svc: 'INTERNET', txOffset: 0 },
            { id: 2, colorName: 'Naranja', hex: '#FF851B', svc: 'INTERNET', txOffset: 0 },
            { id: 3, colorName: 'Verde',   hex: '#2ECC40', svc: 'TV',       txOffset: 1 },
            { id: 4, colorName: 'Marrón',  hex: '#85144b', svc: 'TV',       txOffset: 1 },
            { id: 5, colorName: 'Gris',    hex: '#AAAAAA', svc: 'PHONE',    txOffset: -1 },
            { id: 6, colorName: 'Blanco',  hex: '#FFFFFF', svc: 'PHONE',    txOffset: -1 },
            { id: 7, colorName: 'Rojo',    hex: '#FF4136', svc: 'CCTV',     txOffset: 0 },
            { id: 8, colorName: 'Negro',   hex: '#333333', svc: 'CCTV',     txOffset: 0 },
            { id: 9, colorName: 'Amarillo',hex: '#FFDC00', svc: 'DARK',     txOffset: 0 },
            { id: 10,colorName: 'Violeta', hex: '#B10DC9', svc: 'DARK',     txOffset: 0 },
            { id: 11,colorName: 'Rosa',    hex: '#F012BE', svc: 'DARK',     txOffset: 0 },
            { id: 12,colorName: 'Aqua',    hex: '#7FDBFF', svc: 'DARK',     txOffset: 0 }
        ];
        
        // RUTA DETALLADA REALISTA (CALLE POR CALLE - APROX)
        const ROUTE_NODES = [
            [-12.0967, -77.0250], [-12.1000, -77.0280], [-12.1150, -77.0250], [-12.1350, -77.0220],
            [-12.1550, -77.0200], [-12.1700, -77.0150], [-12.1900, -77.0050], [-12.2100, -76.9800],
            [-12.2500, -76.9200], [-12.2720, -76.8700]
        ];

        const TOOL_INFO = {
            cursor: { name: 'CURSOR', icon: 'fa-arrow-pointer', desc: 'Inspección' },
            splice: { name: 'EMPALME', icon: 'fa-xmarks-lines', desc: 'Fusión (0.05dB)' },
            connector: { name: 'CONECTOR', icon: 'fa-grip-lines-vertical', desc: 'UPC/APC (0.25dB)' },
            splitter: { name: 'SPLITTER', icon: 'fa-share-nodes', desc: '1:8 (10.0dB)' },
            amp: { name: 'EDFA', icon: 'fa-caret-right', desc: 'Ganancia Neta (20dB)' }
        };
        const apiKey = "";
        const OPM_LAMBDAS = [1310, 1490, 1550, 1577, 1625, 'AUTO'];

        class FiberEngine {
            constructor() {
                this.state = {
                    dist: 80.0, baseTx: 3.0, attenuation: 0.25, engineeringMargin: 3.0,
                    events: [], selectedEventId: null, activeFiberIndex: 0, tool: 'cursor', view: 'schematic',
                    lockedPoint: null, mapInspectMarker: null, mapEventMarkers: [],
                    opm: { lambdaIdx: 5, ref: null }, otdr: { rangeIdx: 1, zoom: false, showEvents: true }
                };
                this.otdrRanges = [10, 40, 80, 160];
                this.canvas = document.getElementById('fiberCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.container = document.getElementById('schematic-container');
                
                this.initMap(); this.initOTDR(); this.bindInputs(); 
                this.generateInfrastructure();
                this.loop(); this.updateToolPanel(); 
                setTimeout(() => { this.updateOTDR(); this.drawSchematic(); this.refreshUI(); }, 100);
            }

            // --- CRITICAL UI METHODS ---
            toggleView() {
                const ml = document.getElementById('map-layer'); const sl = document.getElementById('schematic-layer');
                if (this.state.view === 'schematic') {
                    this.state.view = 'map'; ml.classList.remove('hidden'); sl.classList.add('hidden'); setTimeout(() => this.map.invalidateSize(), 100);
                } else {
                    this.state.view = 'schematic'; ml.classList.add('hidden'); sl.classList.remove('hidden');
                }
            }

            updateToolPanel() {
                const info = TOOL_INFO[this.state.tool];
                this.setText('tool-name-display', info.name);
                const iconEl = document.getElementById('tool-icon-display');
                if(iconEl) iconEl.className = `fa-solid ${info.icon}`;
                this.setText('tool-desc-display', info.desc);
            }

            setTool(t) {
                this.state.tool = t;
                document.querySelectorAll('.cad-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tool-'+t).classList.add('active');
                this.updateToolPanel();
            }

            // --- CORE LOGIC ---
            calcPowerAt(km, fiberIdx) {
                const fiberDef = CABLE_CONFIG[fiberIdx];
                const service = SERVICES[fiberDef.svc];
                if (service.name === 'FIBRA OSCURA') return -60; 
                
                let p = this.state.baseTx + fiberDef.txOffset;
                // FORMULA: P_rx = P_tx - (alpha * D) - Margin - Events
                // We apply margin distributed? Or at end? Standard is subtract from total.
                // For trace visualization, we usually don't show margin as a slope, but as a limit.
                // However, user wants "Losses". Let's apply margin only at the end validation or linearly.
                // For accurate point measurement, we just subtract specific losses.
                // The prompt formula says L_total includes Margin. So P_rx at end subtracts margin.
                
                const effectiveKm = Math.min(km, this.state.dist);
                p -= (effectiveKm * this.state.attenuation);
                
                for(let ev of this.state.events) {
                    if (ev.km <= km && ev.fiberIdx === fiberIdx) {
                        if (ev.type === 'amp') {
                            p += (ev.val - 0.5); 
                        } else {
                            p -= ev.val;
                        }
                    }
                }
                
                // If we are at the end, subtract margin for validation check, but for trace?
                // Let's keep margin separate for the "Budget Panel" to avoid confusing trace drop.
                return Math.max(p, -70);
            }
            
            // --- AUTO INFRASTRUCTURE ---
            generateInfrastructure() {
                const REEL_LENGTH = 5.0; // Bobina estándar 4-5km
                const SPLICE_LOSS = 0.1; // 0.1dB typical
                const CONN_LOSS = 0.5; // 0.5dB typical

                this.state.events = this.state.events.filter(e => !e.isSystem);

                // 1. Splices every 5km
                for (let k = REEL_LENGTH; k < this.state.dist; k += REEL_LENGTH) {
                    for (let f = 0; f < 12; f++) {
                        this.state.events.push({
                            id: Date.now() + Math.random(),
                            km: k, type: 'splice', val: SPLICE_LOSS, fiberIdx: f, isSystem: true
                        });
                    }
                }

                // 2. Connectors at Start and End (ODF)
                for (let f = 0; f < 12; f++) {
                     this.state.events.push({ id: Date.now() + Math.random(), km: 0.01, type: 'connector', val: CONN_LOSS, fiberIdx: f, isSystem: true });
                     this.state.events.push({ id: Date.now() + Math.random(), km: this.state.dist - 0.01, type: 'connector', val: CONN_LOSS, fiberIdx: f, isSystem: true });
                }

                this.state.events.sort((a,b) => a.km - b.km);
            }

            // --- GIS MAP ENGINE ---
            initMap() {
                this.map = L.map('map-layer', { center: ROUTE_NODES[2], zoom: 13, zoomControl:false });
                if(L.esri) { L.esri.basemapLayer('Imagery').addTo(this.map); L.esri.basemapLayer('ImageryLabels').addTo(this.map); } 
                else { L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map); }
                this.drawMapFiberLines();
                this.infraLayer = L.layerGroup().addTo(this.map);
                this.addInfrastructureMarkers();
            }

            drawMapFiberLines() {
                const OFFSET_STEP = 0.00003; 
                CABLE_CONFIG.forEach((fib, i) => {
                    const offsetPoints = ROUTE_NODES.map(pt => [pt[0] + (i-5.5)*OFFSET_STEP, pt[1] + (i-5.5)*OFFSET_STEP]);
                    const line = L.polyline(offsetPoints, { color: fib.hex, weight: 2, opacity: 0.9 }).addTo(this.map);
                    line.on('click', (e) => {
                        const clickLat = e.latlng.lat; const clickLng = e.latlng.lng;
                        let bestDist = Infinity; let segIndex = 0;
                        for(let j=0; j<offsetPoints.length-1; j++) {
                            const d = Math.abs(clickLat - offsetPoints[j][0]) + Math.abs(clickLng - offsetPoints[j][1]);
                            if (d < bestDist) { bestDist = d; segIndex = j; }
                        }
                        const totalNodes = offsetPoints.length;
                        const ratio = segIndex / (totalNodes - 1);
                        let km = ratio * this.state.dist;
                        if (this.state.tool === 'cursor') {
                            this.inspectFiber(km, i); this.updateMapInspectionMarker(e.latlng);
                        } else { this.addEvent(km, this.state.tool, i); }
                    });
                    line.bindTooltip(`${fib.id}. ${fib.colorName}`, { sticky:true, direction:'top' });
                });
            }

            addInfrastructureMarkers() {
                ROUTE_NODES.forEach((pt, i) => { L.circleMarker(pt, { radius: 2, color: '#aaa', fillColor: '#444', fillOpacity: 1 }).addTo(this.infraLayer); });
                const splitPt1 = ROUTE_NODES[6]; const mufaIcon = L.divIcon({className: 'icon-mufa', iconSize:[12,8]});
                L.marker(splitPt1, {icon: mufaIcon}).addTo(this.infraLayer).bindPopup("MUFA M-01 (INTERNET)");
                const housePt = [splitPt1[0]+0.0008, splitPt1[1]-0.0008]; 
                L.polyline([splitPt1, housePt], {color:'cyan', dashArray:'3,3', weight:2}).addTo(this.map);
                const napIcon = L.divIcon({className:'icon-nap', iconSize:[10,10]});
                L.marker(housePt, {icon:napIcon}).addTo(this.map).bindPopup("NAP-045");
                const splitPt2 = ROUTE_NODES[8];
                L.marker(splitPt2, {icon: mufaIcon}).addTo(this.infraLayer).bindPopup("MUFA M-02 (CCTV)");
                const camPt = [splitPt2[0]-0.0005, splitPt2[1]-0.0005];
                L.polyline([splitPt2, camPt], {color:'red', dashArray:'3,3', weight:2}).addTo(this.map);
                const camIcon = L.divIcon({className:'icon-camera', html:'<i class="fa-solid fa-video" style="font-size:10px"></i>', iconSize:[16,16]});
                L.marker(camPt, {icon:camIcon}).addTo(this.map).bindPopup("PTZ-102");
            }
            
            updateMapInspectionMarker(latlng) {
                if(this.state.mapInspectMarker) this.map.removeLayer(this.state.mapInspectMarker);
                const icon = L.divIcon({className:'pulse-icon', iconSize:[20,20]});
                this.state.mapInspectMarker = L.marker(latlng, {icon:icon}).addTo(this.map);
            }
            
            updateMapMarkers() { /* ... */ }

            // --- SCHEMATIC RENDER ---
            drawSchematic() {
                const w = this.canvas.width; const h = this.canvas.height; const ctx = this.ctx;
                ctx.clearRect(0,0,w,h);
                const marginX = 60; const usableW = w - marginX*2; const centerY = h/2;
                const grad = ctx.createLinearGradient(0, centerY-100, 0, centerY+100);
                grad.addColorStop(0,'#0a0a0a'); grad.addColorStop(0.5,'#151515'); grad.addColorStop(1,'#0a0a0a');
                ctx.fillStyle = grad; ctx.fillRect(0, centerY-80, w, 160);
                const spacing = 14; const startY = centerY - (12*spacing)/2 + spacing/2;
                
                // LABELS OLT / ONT
                ctx.fillStyle = '#666'; ctx.font = 'bold 10px monospace';
                ctx.textAlign='left'; ctx.fillText('OLT [TX]', 10, 20);
                ctx.textAlign='right'; ctx.fillText('ONT/ODF [RX]', w-10, 20);

                CABLE_CONFIG.forEach((fib, i) => {
                    const y = startY + i*spacing;
                    ctx.beginPath(); ctx.moveTo(0, centerY); ctx.bezierCurveTo(marginX, centerY, marginX, y, marginX+60, y); ctx.lineTo(w-marginX-60, y);
                    ctx.bezierCurveTo(w-marginX, y, w-marginX, centerY, w, centerY);
                    const isActive = (i === this.state.activeFiberIndex);
                    ctx.lineWidth = isActive ? 2 : 1; ctx.strokeStyle = fib.hex; ctx.globalAlpha = isActive ? 1 : 0.3;
                    if(isActive) { ctx.shadowColor=fib.hex; ctx.shadowBlur=10; } else { ctx.shadowBlur=0; }
                    ctx.stroke(); ctx.globalAlpha = 1; ctx.shadowBlur = 0;
                });

                if (this.state.lockedPoint) {
                    const px = marginX + (this.state.lockedPoint.km / this.state.dist) * usableW;
                    const fy = startY + this.state.lockedPoint.fiberIndex * spacing;
                    ctx.beginPath(); ctx.moveTo(px, centerY-90); ctx.lineTo(px, centerY+90);
                    ctx.strokeStyle = '#00bcd4'; ctx.lineWidth = 1; ctx.setLineDash([4,4]); ctx.stroke(); ctx.setLineDash([]);
                    ctx.beginPath(); ctx.arc(px, fy, 4, 0, Math.PI*2); ctx.fillStyle = '#00bcd4'; ctx.fill();
                }
                
                // Draw manual events prominently
                this.state.events.forEach(ev => {
                    const ex = marginX + (ev.km / this.state.dist) * usableW;
                    const fy = startY + ev.fiberIdx * spacing;
                    let icon = '\uf00d'; let color = '#fff'; let size = '10px';
                    if (ev.isSystem) { icon = '\uf111'; color = '#444'; size = '6px'; } 
                    else {
                        if (ev.type === 'amp') { color='#00bcd4'; icon='\uf04b'; }
                        else if (ev.type === 'splitter') { color='#a855f7'; icon='\uf1e0'; }
                        else if (ev.type === 'splice') { color='#ff9800'; icon='\uf00d'; }
                        else { color='#ccc'; icon='\uf7a4'; }
                    }
                    ctx.fillStyle = color; ctx.font=`${size} FontAwesome`; ctx.textAlign='center'; ctx.textBaseline='middle';
                    ctx.fillText(icon, ex, fy);
                });
            }

            // --- OTDR (Corrected Logic) ---
            updateOTDR() {
                if(!this.chart) { this.initOTDR(); return; }
                const fiber = CABLE_CONFIG[this.state.activeFiberIndex];
                let traceColor = fiber.hex;
                if (fiber.hex.toLowerCase() === '#333333' || fiber.hex.toLowerCase() === '#000000') traceColor = '#e0e0e0';

                this.chart.data.datasets[0].borderColor = traceColor;
                this.chart.data.datasets[0].backgroundColor = (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0,0,0,200); g.addColorStop(0, traceColor+'33'); g.addColorStop(1, traceColor+'00'); return g;
                };
                
                const maxX = this.otdrRanges[this.state.otdr.rangeIdx];
                this.chart.options.scales.x.max = maxX;
                
                const data = []; const steps = 500; // Resolution
                const points = [0, this.state.dist];
                // Include ALL events for this fiber (manual + system)
                const activeEvents = this.state.events.filter(e => e.fiberIdx === this.state.activeFiberIndex);
                activeEvents.forEach(e => points.push(e.km));
                for(let i=0; i<=steps; i++) points.push((i/steps)*this.state.dist);
                const sorted = [...new Set(points)].sort((a,b)=>a-b);
                
                let minP = 100, maxP = -100;
                sorted.forEach(km => {
                    if(km>0) {
                        const v1 = this.calcPowerAt(km-0.001, this.state.activeFiberIndex);
                        data.push({x:km, y:v1});
                        if(v1 < minP) minP = v1; if(v1 > maxP) maxP = v1;
                    }
                    const v2 = this.calcPowerAt(km, this.state.activeFiberIndex);
                    data.push({x:km, y:v2});
                    if(v2 < minP) minP = v2; if(v2 > maxP) maxP = v2;
                });
                
                // Scale Logic
                if (this.state.otdr.zoom && this.state.lockedPoint) {
                    const c = this.state.lockedPoint.km; const s = maxX * 0.05;
                    this.chart.options.scales.x.min = Math.max(0, c-s); this.chart.options.scales.x.max = Math.min(this.state.dist, c+s);
                    const p = this.calcPowerAt(c, this.state.activeFiberIndex);
                    this.chart.options.scales.y.min = p-3; this.chart.options.scales.y.max = p+3;
                } else {
                    this.chart.options.scales.x.min = 0; 
                    const safeMin = Math.max(-75, minP - 5);
                    const safeMax = Math.max(10, maxP + 5);
                    this.chart.options.scales.y.min = safeMin;
                    this.chart.options.scales.y.max = safeMax;
                }

                this.chart.data.datasets[0].data = data;
                
                if (this.state.otdr.showEvents) {
                    this.chart.data.datasets[0].pointRadius = (ctx) => {
                        const val = ctx.raw; if (!val) return 0;
                        // Show bigger dots for manual events
                        const ev = activeEvents.find(e => Math.abs(e.km - val.x) < 0.01);
                        if (ev) {
                            return ev.isSystem ? 2 : 5; // Small for system, Big for manual
                        }
                        return 0;
                    };
                    // Dynamic color for points?
                    this.chart.data.datasets[0].pointBackgroundColor = (ctx) => {
                        const val = ctx.raw; if (!val) return 'transparent';
                        const ev = activeEvents.find(e => Math.abs(e.km - val.x) < 0.01);
                        if (ev && ev.isSystem) return '#666'; // Gray for system
                        return '#ff9800'; // Orange for manual
                    };
                } else { this.chart.data.datasets[0].pointRadius = 0; }

                this.chart.update();
            }

            // --- STANDARD ---
            setText(id, t) { const e = document.getElementById(id); if(e) e.innerText=t; }
            setHTML(id, h) { const e = document.getElementById(id); if(e) e.innerHTML=h; }
            setStyle(id, p, v) { const e = document.getElementById(id); if(e) e.style[p]=v; }
            
            inspectFiber(km, idx) {
                this.state.lockedPoint = { km, fiberIndex: idx };
                this.state.activeFiberIndex = idx;
                const hud = document.getElementById('hud-meter');
                if(hud) { hud.classList.remove('hidden','opacity-0','translate-y-2'); hud.classList.add('pointer-events-auto'); }
                
                // MATH PANEL UPDATE
                const txBase = this.state.baseTx;
                const distLoss = km * this.state.attenuation;
                let eventLoss = 0;
                let splicesCount = 0; let connCount = 0;
                for(let ev of this.state.events) {
                    if (ev.km <= km && ev.fiberIdx === idx) {
                         if (ev.type === 'splice') splicesCount++;
                         if (ev.type === 'connector') connCount++;
                         eventLoss += ev.val;
                    }
                }
                const margin = this.state.engineeringMargin;
                // Final power for checking status: Tx - (Fiber + Events) - Margin (if applied to end)
                // Let's show Margin in equation
                const calcRx = txBase - distLoss - eventLoss - margin;

                let mathHTML = `
                    <div class="math-header">CALCULO DE PRESUPUESTO</div>
                    <div class="math-row"><span>1. Potencia TX:</span><span class="val-pos">${txBase.toFixed(2)} dBm</span></div>
                    <div class="math-row"><span>2. Fibra (${this.state.attenuation} dB/km * ${km.toFixed(1)}):</span><span class="val-neg">-${distLoss.toFixed(2)} dB</span></div>
                    <div class="math-row"><span>3. Empalmes (${splicesCount} * 0.1):</span><span class="val-neg">-${(splicesCount*0.1).toFixed(2)} dB</span></div>
                    <div class="math-row"><span>4. Conectores (${connCount} * 0.5):</span><span class="val-neg">-${(connCount*0.5).toFixed(2)} dB</span></div>
                    <div class="math-row"><span>5. Margen Seguridad:</span><span class="val-neg">-${margin.toFixed(2)} dB</span></div>
                    <div style="border-top:1px solid #555; margin-top:4px; padding-top:2px; display:flex; justify-content:space-between; font-size:12px;">
                        <span>RX FINAL:</span><span style="font-weight:bold; color:${calcRx<-28?'#f87171':calcRx>0?'#fbbf24':'#4ade80'}">${calcRx.toFixed(2)} dBm</span>
                    </div>
                    <div style="text-align:center; margin-top:2px; font-size:8px; color:#888;">(RX < -28 = CAIDA | RX > 0 = SATURADO)</div>
                `;
                this.setHTML('math-display', mathHTML);
                document.getElementById('math-display').classList.remove('hidden');

                const f = CABLE_CONFIG[idx]; const s = SERVICES[f.svc];
                this.setStyle('hud-fiber-name','color',f.hex); this.setStyle('hud-fiber-color','backgroundColor',f.hex);
                this.setText('hud-fiber-id', `HILO ${f.id} (${f.colorName})`);
                this.setText('hud-dist', km.toFixed(3)+' km');
                this.setText('panel-fiber-id', `Hilo ${f.id}`); this.setStyle('panel-fiber-id','color',f.hex);
                this.setText('panel-service', s.name); this.setText('panel-lambda', s.lambda+' nm');
                this.setText('panel-coef', this.state.attenuation.toFixed(2)+' dB/km');
                
                this.refreshHUDDisplay();
                this.updateOTDR(); this.drawSchematic();
                
                const statusEl = document.getElementById('header-status');
                if(calcRx < -28) { statusEl.innerText = "NO CIERRA"; statusEl.className = "text-xs font-bold text-red-500 bg-red-900/20 px-2 py-0.5 rounded border border-red-900/50"; }
                else if(calcRx > 0) { statusEl.innerText = "SATURADO"; statusEl.className = "text-xs font-bold text-yellow-500 bg-yellow-900/20 px-2 py-0.5 rounded border border-yellow-900/50"; }
                else { statusEl.innerText = "OPERATIVO"; statusEl.className = "text-xs font-bold text-cad-success bg-green-900/20 px-2 py-0.5 rounded border border-green-900/50"; }
            }

            closeHUD() {
                const hud = document.getElementById('hud-meter'); if(hud) hud.classList.add('hidden');
                this.state.lockedPoint = null;
                if(this.state.mapInspectMarker) { this.map.removeLayer(this.state.mapInspectMarker); this.state.mapInspectMarker = null; }
                this.drawSchematic();
            }

            bindInputs() {
                const rs = () => { this.canvas.width = this.container.clientWidth; this.canvas.height = this.container.clientHeight; this.drawSchematic(); };
                window.addEventListener('resize', rs); rs();
                this.canvas.addEventListener('click', (e) => {
                    const r = this.canvas.getBoundingClientRect();
                    const x = e.clientX - r.left; const y = e.clientY - r.top;
                    const mx = 60; const uw = this.canvas.width - mx*2;
                    let km = ((x-mx)/uw)*this.state.dist; if(km<0) km=0; if(km>this.state.dist) km=this.state.dist;
                    
                    const cy = this.canvas.height/2; const sp = 14; const startY = cy - (12*sp)/2 + sp/2;
                    let fIdx = Math.round((y-startY)/sp); if(fIdx<0) fIdx=0; if(fIdx>11) fIdx=11;
                    
                    if(this.state.tool==='cursor') {
                        const hit = this.state.events.find(ev => !ev.isSystem && Math.abs(ev.km-km)<0.5 && ev.fiberIdx===fIdx);
                        if(hit) this.selectEvent(hit.id); else this.inspectFiber(km, fIdx);
                    } else this.addEvent(km, this.state.tool, fIdx);
                });
                
                document.getElementById('param-dist').addEventListener('change', (e) => { this.state.dist = parseFloat(e.target.value); this.generateInfrastructure(); this.updateOTDR(); });
                document.getElementById('param-tx').addEventListener('change', (e) => { this.state.baseTx = parseFloat(e.target.value); this.updateOTDR(); });
                document.getElementById('param-att').addEventListener('change', (e) => { this.state.attenuation = parseFloat(e.target.value); this.updateOTDR(); });
                document.getElementById('param-margin').addEventListener('change', (e) => { this.state.engineeringMargin = parseFloat(e.target.value); });
            }

            addEvent(km, type, fIdx) {
                let v = 0.1; // Splice
                if(type==='connector') v=0.5; if(type==='splitter') v=10.0; if(type==='amp') v=20; 
                const ev = { id:Date.now(), km, type, val:v, fiberIdx:fIdx, isSystem:false };
                this.state.events.push(ev); this.state.events.sort((a,b)=>a.km-b.km);
                this.refreshUI(); this.showToast("Componente añadido", "success");
            }
            selectEvent(id) {
                this.state.selectedEventId = id; const p = document.getElementById('prop-panel'); this.closeHUD();
                if(id) {
                    const e = this.state.events.find(x=>x.id===id); p.classList.remove('hidden');
                    this.setText('edit-type', e.type.toUpperCase()); document.getElementById('prop-km').value=e.km.toFixed(2); document.getElementById('prop-val').value=e.val;
                } else p.classList.add('hidden');
                this.drawSchematic();
            }
            updateSelected() {
                const e = this.state.events.find(x=>x.id===this.state.selectedEventId);
                if(e) { e.km = parseFloat(document.getElementById('prop-km').value); e.val = parseFloat(document.getElementById('prop-val').value); }
                this.refreshUI();
            }
            deleteSelected() {
                this.state.events = this.state.events.filter(x=>x.id!==this.state.selectedEventId);
                this.selectEvent(null); this.refreshUI();
            }
            resetEvents() { this.state.events=[]; this.generateInfrastructure(); this.selectEvent(null); this.refreshUI(); }
            
            refreshUI() {
                const l = document.getElementById('events-list'); l.innerHTML='';
                const manualEvents = this.state.events.filter(e => !e.isSystem);
                this.setText('event-count', manualEvents.length);
                manualEvents.forEach(ev => {
                    const f = CABLE_CONFIG[ev.fiberIdx];
                    const d = document.createElement('div'); d.className = `text-[10px] p-2 rounded border border-cad-border bg-[#111] cursor-pointer hover:border-cad-accent flex justify-between ${ev.id===this.state.selectedEventId?'border-cad-accent':''}`;
                    d.innerHTML = `<span style="color:${f.hex}">${ev.type.toUpperCase()}</span> <span>${ev.km.toFixed(2)}km</span>`;
                    d.onclick = () => this.selectEvent(ev.id); l.appendChild(d);
                });
                this.drawSchematic(); this.updateOTDR();
            }

            opmCycleLambda() { this.state.opm.lambdaIdx = (this.state.opm.lambdaIdx + 1) % OPM_LAMBDAS.length; this.refreshHUDDisplay(); }
            opmSetRef() { if(!this.state.lockedPoint) return; this.state.opm.ref = this.calculateFinalPower(); this.flashScreen("REF"); this.refreshHUDDisplay(); }
            opmSave() { if(!this.state.lockedPoint) return; this.flashScreen("SAVED"); this.showToast("Medición guardada", "success"); }
            flashScreen(txt) { const s=document.getElementById('opm-lcd'); const m=document.getElementById('opm-msg'); s.classList.add('flash'); if(m){ m.innerText=txt; m.style.display='block'; setTimeout(()=>{ s.classList.remove('flash'); m.style.display='none'; },1000); } }
            
            calculateFinalPower() {
                if(!this.state.lockedPoint) return -99;
                const real = this.calcPowerAt(this.state.lockedPoint.km, this.state.lockedPoint.fiberIndex);
                return real;
            }
            refreshHUDDisplay() {
                if(!this.state.lockedPoint) return;
                const man = OPM_LAMBDAS[this.state.opm.lambdaIdx];
                this.setText('hud-lambda', man==='AUTO'?'AUTO':man+'nm');
                const val = this.calculateFinalPower();
                let dVal = val;
                if(this.state.opm.ref!==null) { dVal=val-this.state.opm.ref; this.setText('hud-unit','dB'); this.setText('hud-mode','REL'); this.setText('hud-ref-val', this.state.opm.ref.toFixed(2)); }
                else { this.setText('hud-unit','dBm'); this.setText('hud-mode','ABS'); this.setText('hud-ref-val','--'); }
                if(val<=-60) this.setText('hud-pwr','LO'); else this.setText('hud-pwr', dVal.toFixed(2));
            }

            otdrAuto() { this.state.otdr.rangeIdx=2; this.state.otdr.zoom=false; this.updateOTDR(); this.showToast("Escala Auto"); }
            otdrRange() { this.state.otdr.rangeIdx = (this.state.otdr.rangeIdx+1)%this.otdrRanges.length; this.updateOTDR(); this.showToast("Rango: "+this.otdrRanges[this.state.otdr.rangeIdx]+"km"); }
            otdrZoom() { this.state.otdr.zoom = !this.state.otdr.zoom; document.getElementById('otdr-zoom-badge').style.display = this.state.otdr.zoom?'block':'none'; this.updateOTDR(); }
            otdrEvents() { this.state.otdr.showEvents = !this.state.otdr.showEvents; this.updateOTDR(); }

            exportReport() {
                const report = { project: "LIMA_DORSAL", date: new Date().toLocaleString(), events: this.state.events };
                const ws = XLSX.utils.json_to_sheet(this.state.events);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, "FiberLink_Report.xlsx");
                this.showToast("Excel Exportado", "success");
            }
            showToast(msg, type='info') {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div'); t.className='toast'; t.innerHTML=`<span>${msg}</span>`;
                if(type==='success') t.style.borderLeftColor='#4caf50';
                c.appendChild(t); setTimeout(()=>{ t.remove() },3000);
            }

            initOTDR() { /* ... */ }
            // ... (rest of methods)
            
            toggleAI() { const p = document.getElementById('ai-panel'); p.classList.toggle('open'); }
            // ... (AI methods)
            async askGemini(predefinedPrompt = null) { /* ... */ }
            async callGemini(prompt) { /* ... */ }
            
            loop() { requestAnimationFrame(() => this.loop()); }
        }

        window.onload = () => { window.app = new FiberEngine(); };
    </script>
</body>
</html>
